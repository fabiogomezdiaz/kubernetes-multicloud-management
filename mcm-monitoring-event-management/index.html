<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Monitoring and event management with MCM - Cookbook for managing Kuberenetes clusters with IBM Multicloud Manager</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Monitoring and event management with MCM";
    var mkdocs_page_input_path = "mcm-monitoring-event-management.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Cookbook for managing Kuberenetes clusters with IBM Multicloud Manager</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../quickstart/">Quick Start</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../multicloud_scenarios/">Scenarios for multi-cluster management</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../mcm-applications/">MCM Applications</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../mcm-devops/">DevOps with MCM</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../policy/">Policy and Compliance</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Monitoring and event management with MCM</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#ibm-multicloud-manager-monitoring-and-event-management">IBM Multicloud Manager - monitoring and event management</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#overall-mcm-dashboard">Overall MCM dashboard</a></li>
        
            <li><a class="toctree-l3" href="#mcm-application-monitoring">MCM Application monitoring</a></li>
        
            <li><a class="toctree-l3" href="#ibm-cloud-event-management-for-ibm-multicloud-manager">IBM Cloud Event Management for IBM Multicloud Manager</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../mcm-openshift/">Manage Red Hat OpenShift platform with MCM</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../mcm-eks/">Manage AWS EKS cluster with MCM</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Cookbook for managing Kuberenetes clusters with IBM Multicloud Manager</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Monitoring and event management with MCM</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="ibm-multicloud-manager-monitoring-and-event-management">IBM Multicloud Manager - monitoring and event management</h1>
<p><strong>Author:</strong> Rafal Szypulka (rafal.szypulka@pl.ibm.com)</p>
<p>This chapter is focused on monitoring and event management features delivered by IBM Multicloud Manager.</p>
<p>Check chapter <a href="chapter8_day2operation.md">Day 2 operation with MCM</a> for broader description of Cloud Service Management and Operations aspects.</p>
<ul>
<li><a href="#overall-dashboard">Overall MCM dashboard</a></li>
<li><a href="#mcm-application-monitoring">MCM Application monitoring</a><ul>
<li><a href="#metrics-collection-and-visualization">Metrics collection and visualization</a></li>
</ul>
</li>
<li><a href="#ibm-cloud-event-management-for-ibm-multicloud-manager">IBM Cloud Event Management for IBM Multicloud Manager</a><ul>
<li><a href="#installing-event-management-for-ibm-multicloud-manager">Installing Event Management for IBM Multicloud Manager</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#installation-of-the-cloud-event-management-controller">Installation of the Cloud Event Management controller</a></li>
<li><a href="#installation-of-the-cloud-event-management-for-ibm-multicloud-manager">Installation of the Cloud Event Management for IBM Multicloud Manager</a></li>
<li><a href="#first-logon-to-cem-console">First logon to CEM console</a></li>
<li><a href="#cloud-event-management-documentation">Cloud Event Management documentation</a></li>
</ul>
</li>
</ul>
<h2 id="overall-mcm-dashboard">Overall MCM dashboard</h2>
<p>IBM Multicloud Manager Overview dashboard is available from the MCM menu: <code>Overview</code>. It shows general set of metrics collected from managed clusters:</p>
<ul>
<li>Cluster Health</li>
<li>Helm Releases</li>
<li>Pod Health</li>
<li>Persistent Volume Health</li>
<li>CPU Health</li>
<li>Memory Health</li>
<li>Storage Capacity</li>
</ul>
<p><img alt="" src="../images/mcm-monitoring-event-management/mcm-overall.png" /></p>
<h2 id="mcm-application-monitoring">MCM Application monitoring</h2>
<h3 id="metrics-collection-and-visualization">Metrics collection and visualization</h3>
<p>Application dashboards are available from the MCM UI: <code>Applications -&gt; Launch Health View</code></p>
<p><img alt="" src="../images/mcm-monitoring-event-management/mcm-app-monit.png" /></p>
<p>A Grafana Dashboard for MCM applications is generated automatically for each deployed application and shows metrics related to resource utilization (CPU, memory, network) of the application containers and overall resource utilization of the clusters where an application has been deployed.</p>
<p><img alt="" src="../images/mcm-monitoring-event-management/mcm-grafana.png" /></p>
<p>MCM federated Prometheus is a data source for an application monitoring dashboard. MCM Controller installation deploys a federated Prometheus instance which will pull selected metric data from the Prometheus instances located on managed ICP clusters.
Deployment name: <code>mcm-controller-ibm-mcm-controller-prometheus</code></p>
<p>Initially, just after MCM installation, the MCM federated Prometheus instance doesn't collect any data. Its configuration is generated dynamically during application deployment via MCM.
Target ICP clusters are added to the MCM federated Prometheus instance ConfigMap during application deployment.</p>
<p>The example below, shows a dynamic update of the MCM federated Prometheus ConfigMap after deployment of the application to two ICP clusters:</p>
<pre><code>   scrape_configs:
    - job_name: mcm-dynamic-se-prod-31
      honor_labels: true
      params:
        match[]:
        - '{job=&quot;kubernetes-cadvisor&quot;}'
      scrape_interval: 1m
      scrape_timeout: 30s
      metrics_path: /federate
      scheme: https
      static_configs:
      - targets:
        - se-prod-31.prometheus.icp:443
        labels:
          cluster_name: se-prod-31
      tls_config:
        cert_file: /prometheus/hcm/mcm-dynamic-se-prod-31/tls.crt
        key_file: /prometheus/hcm/mcm-dynamic-se-prod-31/tls.key
        insecure_skip_verify: true
    - job_name: mcm-dynamic-se-stg
      honor_labels: true
      params:
        match[]:
        - '{job=&quot;kubernetes-cadvisor&quot;}'
      scrape_interval: 1m
      scrape_timeout: 30s
      metrics_path: /federate
      scheme: https
      static_configs:
      - targets:
        - se-stg.prometheus.icp:443
        labels:
          cluster_name: se-stg
      tls_config:
        cert_file: /prometheus/hcm/mcm-dynamic-se-stg/tls.crt
        key_file: /prometheus/hcm/mcm-dynamic-se-stg/tls.key
        insecure_skip_verify: true
</code></pre>

<p>The additional configuration instructs MCM federated Prometheus instance to collect selected (cAdvisor) metrics from two child ICP Prometheus instances, located respectively on two ICP clusters: <code>se-prod-31</code> and <code>se-stg</code>.
More information about Prometheus federation mechanisms: <a href="https://prometheus.io/docs/prometheus/latest/federation/">https://prometheus.io/docs/prometheus/latest/federation/</a>.</p>
<h2 id="ibm-cloud-event-management-for-ibm-multicloud-manager">IBM Cloud Event Management for IBM Multicloud Manager</h2>
<p>IBM Cloud Event Management allows to set up a real-time incident management for the applications and infrastructure managed by the Multi Cloud Manager. Incidents are generated from events/alerts which indicate that something has happened on an application, service, or another monitored object.
Cloud Event Management can receive events from various monitoring sources, either on premise or in the cloud.</p>
<p>In the MCM environment, the CEM collects alerts from Prometheus instances located at each managed cluster. CEM for MCM automatically configures managed Prometheus Alertmanager instances to send alert notifications to the central CEM instance installed on MCM Controller.</p>
<h3 id="installing-event-management-for-ibm-multicloud-manager">Installing Event Management for IBM Multicloud Manager</h3>
<p>You can download the IBM Cloud Event Management optional component for IBM Multicloud Manager from the IBM Passport Advantage website, then import PPA to the ICP container registry and deploy CEM charts. Install IBM Multicloud Manager on your hub-cluster and IBM Multicloud Manager Klusterlet on all clusters that you want to manage.</p>
<p>Use the following <a href="https://www.ibm.com/support/knowledgecenter/SSURRN/com.ibm.cem.doc/em_obtain_mcmppa.html">instructions</a> to download and install Cloud Event Management.</p>
<p>The following procedure describe installation and configuration steps on example ICP 3.1 cluster running MCM controller. The sequence of the steps is important.</p>
<h4 id="prerequisites">Prerequisites</h4>
<ul>
<li>MCM Controller and MCM Klusterlet deployed on ICP 3.1 cluster</li>
<li>CEM PPA packages imported as per <a href="https://www.ibm.com/support/knowledgecenter/SSURRN/com.ibm.cem.doc/em_obtain_mcmppa.html">instructions</a>.</li>
<li>ICP user has a <code>Cluster administrator</code> role within a Team which has a resource management assigned to a managed cluster namespace.</li>
</ul>
<h4 id="installation-of-the-cloud-event-management-controller">Installation of the Cloud Event Management controller</h4>
<p>Deploy an alerttargetcontroller chart on MCM Contoller cluster in the <code>kube-system</code> namespace.</p>
<p><img alt="" src="../images/mcm-monitoring-event-management/alerttarget.png" />
<code>MCM Fullname Override</code> option can be obtained using:</p>
<pre><code>kubectl get po -n kube-system|grep klusterlet
</code></pre>

<p>Copy the pod name part before the <code>klusterlet</code> word as on the picture below:</p>
<p><img alt="" src="../images/mcm-monitoring-event-management/mcm-override.png" /></p>
<p><code>ICP Cluster namespace</code> is the cluster namespace created during klusteret deployment. In our case the namespace name is <code>mcm-se-dev-31</code>. It can be obtained using:</p>
<pre><code>kubectl get clusters --all-namespaces
NAMESPACE             NAME              AGE
mcm-se-dev-31         se-dev-31         1d
mcm-se-prod-rhel-31   se-prod-rhel-31   1d
</code></pre>

<p>After chart deployment, make sure the <code>alerttargetcontroller</code> pod is running.</p>
<h4 id="installation-of-the-cloud-event-management-for-ibm-multicloud-manager">Installation of the Cloud Event Management for IBM Multicloud Manager</h4>
<p>Deploy <code>ibm-cem</code> chart from the local-chart repo in the <code>kube-system</code> namespace on the MCM Controller cluster.
<img alt="" src="../images/mcm-monitoring-event-management/cem.png" />
In our setup we used ICP UI console IP address for both <code>ICP Master IP</code> and <code>Ingress Domain</code> options.</p>
<p>After deployment, wait a couple of minutes to start all the CEM pods and run the following command to configure OIDC registration with IBM Cloud Private:</p>
<pre><code>kubectl exec -n kube-system -t `kubectl get pods -l release=cem -n kube-system \
| grep &quot;cem-ibm-cem-cem-users&quot; | grep &quot;Running&quot; | head -n 1 \
| awk '{print $1}'` bash -- &quot;/etc/oidc/oidc_reg.sh&quot; &quot;`echo $(kubectl get secret platform-oidc-credentials -o yaml -n kube-system \
| grep OAUTH2_CLIENT_REGISTRATION_SECRET: | awk '{print $2}')`&quot;
</code></pre>

<p>Verify the alerttarget has been created:</p>
<pre><code>kubectl get alerttarget --all-namespaces
NAMESPACE    NAME                   AGE
mcm-se-dev   mcm-se-dev-se-dev-31   1d
</code></pre>

<p>At this point the ConfigMaps for managed Prometheus: <code>monitoring-prometheus-alertmanager</code> and <code>monitoring-prometheus-alertrules</code> should be automatically updated by the alerttargetcontroller.
Verify it using:</p>
<pre><code>kubectl get cm monitoring-prometheus-alertmanager -n kube-system -o yaml
</code></pre>

<p>in the <code>route:</code> -&gt;  <code>routes:</code> section you should see:</p>
<pre><code>      - receiver: cemwebhook
        group_by:
        - alertname
        - instance
        - severity
        continue: true
        group_wait: 10s
        group_interval: 10s
        repeat_interval: 1m
</code></pre>

<p>and in the <code>receivers:</code> section you should see:</p>
<pre><code>    - name: cemwebhook
      webhook_configs:
      - send_resolved: true
        http_config:
          tls_config:
            insecure_skip_verify: true
        url: https://172.16.50.227:8443/norml/webhook/prometheus/se-team/6196999a-6c1c-43de-9769-ef9a5c7b0bad/jWa3zrTOSS_2p0zJYmHKQA3gA5HLADu7X-FgdDt8yz4
    templates: []
</code></pre>

<p>Note, the CEM <code>url:</code> will be different in your environment.</p>
<p>The CEM Alert Target Controller adds a couple of sample alert definitions to the <code>monitoring-prometheus-alertrules</code>  ConfigMap. This can be verified using:</p>
<pre><code>kubectl edit cm monitoring-prometheus-alertrules -n kube-system
</code></pre>

<p>These alert rules can be customized to the local requirements. We recommend to add <a href="https://github.com/ibm-cloud-architecture/CSMO-ICP/tree/master/prometheus/alerts_prometheus2.x">best practice alert definitions for ICP platform</a>.</p>
<p>Check the Prometheus Alertmanager logs to verify if there are no errors during sending webhook notifications to CEM.</p>
<pre><code>kubectl logs &lt;alertmanager pod&gt; -n kube-system
</code></pre>

<h4 id="first-logon-to-cem-console">First logon to CEM console</h4>
<p>Cloud Event Management console can be accessed from the Multicloud Manager console. Logon to MCM UI as one of the Team (mentioned in the <a href="#prerequisites">prerequisites</a> section) members and select <code>Event Management</code>.</p>
<p><img alt="" src="../images/mcm-monitoring-event-management/cem-login.png" /></p>
<p>You may be asked to authenticate again with the ICP user and you should see one or more subscriptions.</p>
<p><img alt="" src="../images/mcm-monitoring-event-management/cem-subs.png" /></p>
<p>Example subscription <code>se-team</code> on the picture above is a name of the ICP team authorised to manage a cluster namespace.</p>
<p>Click <code>Launch</code> and if some defined Prometheus alerts are active (you can verify it in the ICP console <code>Platform -&gt; Alerting</code>), you should see incidents in CEM UI:</p>
<p><img alt="" src="../images/mcm-monitoring-event-management/cem-incidents.png" /></p>
<h4 id="cloud-event-management-documentation">Cloud Event Management documentation</h4>
<p>More information about how to operate and use the Cloud Event Management: <a href="https://www.ibm.com/support/knowledgecenter/SSURRN/com.ibm.cem.doc/index.html">Cloud Event Management documentation</a></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../mcm-openshift/" class="btn btn-neutral float-right" title="Manage Red Hat OpenShift platform with MCM">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../policy/" class="btn btn-neutral" title="Policy and Compliance"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../policy/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../mcm-openshift/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
